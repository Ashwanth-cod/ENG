<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ENG Playground</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #000000;
      --btn-bg: #007acc;
      --btn-fg: #ffffff;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }

    header {
      background-color: var(--btn-bg);
      color: var(--btn-fg);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-wrap {
      width: 50%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
    }

    textarea {
      flex: 1;
      width: 100%;
      font-family: monospace;
      font-size: 1rem;
      padding: 1rem;
      border: none;
      outline: none;
      resize: none;
    }

    .output {
      width: 50%;
      padding: 1rem;
      background: #f9f9f9;
      font-family: monospace;
      overflow-y: auto;
    }

    .buttons {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f0f0f0;
      border-top: 1px solid #ccc;
    }

    button {
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background: #005fa3;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --fg: #f0f0f0;
        --btn-bg: #1e88e5;
        --btn-fg: #fff;
      }

      .output {
        background: #1b1b1b;
        color: #f0f0f0;
      }

      .buttons {
        background: #1a1a1a;
        border-top: 1px solid #333;
      }

      .editor-wrap {
        border-right: 1px solid #333;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ENG Playground</h1>
    <button onclick="toggleTheme()">ðŸŒ“ Toggle Theme</button>
  </header>

  <main>
    <div class="editor-wrap">
      <textarea id="editor"></textarea>
      <div class="buttons">
        <button onclick="runCode()">â–¶ Run</button>
        <button onclick="clearOutput()">ðŸ§¹ Clear</button>
        <button onclick="copyOutput()">ðŸ“‹ Copy</button>
      </div>
    </div>
    <pre id="output" class="output"></pre>
  </main>

  <script>
    const editorEl = document.getElementById("editor");
    const outputEl = document.getElementById("output");

    const storedCode = localStorage.getItem("engCode");
    editorEl.value = storedCode || `// ENG Example
say "Welcome to ENG!"
let x be 3
let y be x + 4
say "x + y ="
say x + y

define double n:
  say n * 2

call double 10
call double y

repeat 3 times:
  say "Repeating..."`;

    localStorage.removeItem("engCode");

    function runCode() {
      const code = editorEl.value;
      outputEl.textContent = "";

      const lines = code.split("\n");
      const context = {};
      const functions = {};

      let i = 0;

      while (i < lines.length) {
        let line = lines[i].trim();

        if (line === "" || line.startsWith("//")) {
          i++;
          continue;
        }

        if (line.startsWith("say ")) {
          const expression = line.slice(4).trim();
          try {
            const result = evaluate(expression, context);
            outputEl.textContent += result + "\n";
          } catch (e) {
            outputEl.textContent += "Error: " + e.message + "\n";
          }
        } else if (line.startsWith("let ")) {
          const parts = line.slice(4).split(" be ");
          if (parts.length === 2) {
            const name = parts[0].trim();
            const value = evaluate(parts[1], context);
            context[name] = value;
          } else {
            outputEl.textContent += "Invalid let syntax\n";
          }
        } else if (line.startsWith("define ")) {
          const match = line.match(/^define (\w+)\s*(\w*)\s*:/);
          if (match) {
            const [, funcName, param] = match;
            const body = [];
            i++;
            while (i < lines.length && lines[i].trim() !== "" && !lines[i].startsWith("define ") && !lines[i].startsWith("call ") && !lines[i].startsWith("repeat ") && !lines[i].startsWith("let ") && !lines[i].startsWith("say ")) {
              body.push(lines[i]);
              i++;
            }
            functions[funcName] = { param, body };
            continue;
          } else {
            outputEl.textContent += "Invalid function syntax\n";
          }
        } else if (line.startsWith("call ")) {
          const parts = line.slice(5).split(" ");
          const funcName = parts[0];
          const arg = parts.slice(1).join(" ");
          const func = functions[funcName];
          if (func) {
            const funcContext = { ...context };
            if (func.param) {
              funcContext[func.param] = evaluate(arg, context);
            }
            for (const funcLine of func.body) {
              if (funcLine.trim().startsWith("say ")) {
                const expr = funcLine.trim().slice(4);
                try {
                  const result = evaluate(expr, funcContext);
                  outputEl.textContent += result + "\n";
                } catch (e) {
                  outputEl.textContent += "Error in function: " + e.message + "\n";
                }
              }
            }
          } else {
            outputEl.textContent += "Function not found: " + funcName + "\n";
          }
        } else if (line.startsWith("repeat ")) {
          const match = line.match(/^repeat (\d+) times:/);
          if (match) {
            const times = parseInt(match[1]);
            const body = [];
            i++;
            while (i < lines.length && lines[i].trim() !== "" && !lines[i].startsWith("define ") && !lines[i].startsWith("call ") && !lines[i].startsWith("repeat ") && !lines[i].startsWith("let ") && !lines[i].startsWith("say ")) {
              body.push(lines[i]);
              i++;
            }
            for (let r = 0; r < times; r++) {
              for (const repeatLine of body) {
                if (repeatLine.trim().startsWith("say ")) {
                  const expr = repeatLine.trim().slice(4);
                  try {
                    const result = evaluate(expr, context);
                    outputEl.textContent += result + "\n";
                  } catch (e) {
                    outputEl.textContent += "Error in repeat: " + e.message + "\n";
                  }
                }
              }
            }
            continue;
          } else {
            outputEl.textContent += "Invalid repeat syntax\n";
          }
        } else {
          outputEl.textContent += "Unknown command: " + line + "\n";
        }

        i++;
      }
    }

    function evaluate(expr, context) {
      const keys = Object.keys(context);
      const values = Object.values(context);
      return new Function(...keys, `return ${expr};`)(...values);
    }

    function clearOutput() {
      outputEl.textContent = "";
    }

    function copyOutput() {
      navigator.clipboard.writeText(outputEl.textContent)
        .then(() => alert("Output copied to clipboard!"))
        .catch(() => alert("Failed to copy output."));
    }

    function toggleTheme() {
      document.documentElement.classList.toggle("dark-mode");
    }

    // Optional: save to localStorage
    editorEl.addEventListener("input", () => {
      localStorage.setItem("engCode", editorEl.value);
    });
  </script>
</body>
</html>
