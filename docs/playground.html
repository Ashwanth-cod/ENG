<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ENG Playground</title>
  <style>
    :root {
      --bg: #fff;
      --fg: #000;
      --panel: #f5f5f5;
      --accent: #0077ff;
    }

    [data-theme="dark"] {
      --bg: #1e1e1e;
      --fg: #e0e0e0;
      --panel: #2a2a2a;
      --accent: #66ccff;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: var(--panel);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .theme-toggle:hover {
      transform: rotate(180deg);
    }

    main {
      display: flex;
      flex: 1;
      flex-direction: row;
      padding: 1rem;
      gap: 1rem;
    }

    textarea, pre {
      width: 100%;
      height: 100%;
      padding: 1rem;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 1rem;
      border: 1px solid #ccc;
      background: var(--panel);
      color: var(--fg);
    }

    pre {
      white-space: pre-wrap;
      overflow-y: auto;
    }

    .editor-wrap, .output-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      background-color: var(--accent);
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .output-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .icon-button {
      background-color: var(--accent);
      color: white;
      padding: 0.4rem 0.6rem;
      font-size: 1.2rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .icon-button:hover {
      background-color: #005ecb;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ENG Playground</h1>
    <button class="theme-toggle" title="Toggle theme">üåì</button>
  </header>

  <main>
    <div class="editor-wrap">
      <textarea id="editor"></textarea>
      <button onclick="runCode()">‚ñ∂ Run</button>
    </div>

    <div class="output-wrap">
      <pre id="output">// Output will appear here</pre>
      <div class="output-controls">
        <button class="icon-button" onclick="copyOutput()" title="Copy Output">üìã</button>
        <button class="icon-button" onclick="clearOutput()" title="Clear Output">üóëÔ∏è</button>
      </div>
    </div>
  </main>

  <script>
    const editorEl = document.getElementById("editor");
    const outputEl = document.getElementById("output");

    editorEl.value = `// Full ENG example
say "Welcome to ENG!"
let x be 3
let y be x + 4
say "x + y ="
say x + y

define double n:
  say n * 2

call double 10
call double y

repeat 3 times:
  say "Repeating..."`;

    window.addEventListener("load", () => {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
    });

    document.querySelector(".theme-toggle").onclick = () => {
      const current = document.documentElement.getAttribute("data-theme");
      document.documentElement.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    };

    function runCode() {
      const code = editorEl.value;
      try {
        const output = interpretENG(code);
        outputEl.textContent = output.trim() || "// (no output)";
      } catch (e) {
        outputEl.textContent = "Error: " + e.message;
      }
    }

    function interpretENG(code) {
      const lines = code
        .split("\n")
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("//"));

      const vars = {};
      const funcs = {};
      const out = [];

      let i = 0;
      while (i < lines.length) {
        const line = lines[i];

        if (line.startsWith("say ")) {
          out.push(evalExpr(line.slice(4), vars));

        } else if (line.startsWith("let ")) {
          const [name, expr] = line.slice(4).split(" be ");
          vars[name.trim()] = evalExpr(expr, vars);

        } else if (line.startsWith("define ")) {
          const fnHeader = line.slice(7).split(":")[0];
          const [fnName, param] = fnHeader.trim().split(" ");
          const body = [];

          i++;
          while (i < lines.length && !lines[i].includes(":") && !lines[i].startsWith("define")) {
            body.push(lines[i]);
            i++;
          }
          funcs[fnName] = { param, body };
          i--;

        } else if (line.startsWith("call ")) {
          const [fnName, argExpr] = line.slice(5).split(" ");
          const argVal = evalExpr(argExpr, vars);

          if (funcs[fnName]) {
            const { param, body } = funcs[fnName];
            const fnVars = { ...vars, [param]: argVal };
            for (const stmt of body) {
              if (stmt.startsWith("say ")) {
                out.push(evalExpr(stmt.slice(4), fnVars));
              }
            }
          } else {
            out.push(`Error: function '${fnName}' not defined`);
          }

        } else if (line.startsWith("repeat ")) {
          const match = line.match(/^repeat (\d+) times:/);
          if (match) {
            const times = parseInt(match[1]);
            const body = [];

            i++;
            while (i < lines.length && !lines[i].includes(":") && !lines[i].startsWith("repeat")) {
              body.push(lines[i]);
              i++;
            }
            i--;

            for (let r = 0; r < times; r++) {
              for (const stmt of body) {
                if (stmt.startsWith("say ")) {
                  out.push(evalExpr(stmt.slice(4), vars));
                }
              }
            }
          }

        } else {
          out.push("Unrecognized: " + line);
        }

        i++;
      }

      return out.join("\n");
    }

function evalExpr(expr, vars) {
  try {
    // Remove string literals so we don't misinterpret words inside them as variables
    const noStrings = expr.replace(/(["'`])(?:\\.|[^\\])*?\1/g, "");

    // Find all identifiers (words that look like variable names)
    const varRegex = /\b[a-zA-Z_]\w*\b/g;
    const usedVars = noStrings.match(varRegex) || [];

    for (const name of usedVars) {
      if (!(name in vars) && !isKeyword(name)) {
        throw new Error(`Variable '${name}' is not defined`);
      }
    }

    // Evaluate the expression safely
    const fn = new Function(...Object.keys(vars), `return (${expr})`);
    return fn(...Object.values(vars));
  } catch (e) {
    return `Error in expression "${expr}": ${e.message}`;
  }
}

// Helper to ignore JS built-in keywords or literals
function isKeyword(name) {
  return ['true', 'false', 'null', 'undefined', 'NaN', 'Infinity'].includes(name) || !isNaN(Number(name));
}

    function clearOutput() {
      outputEl.textContent = "// Output cleared.";
    }

    function copyOutput() {
      const text = outputEl.textContent;
      navigator.clipboard.writeText(text)
        .then(() => alert("Output copied!"))
        .catch(() => prompt("Copy manually:", text));
    }
  </script>
</body>
</html>
